import { OOXXBoard } from '../components/OOXXBoard';
import { GameToolbar } from '../components/GameToolbar';
import { WinDialog } from '../components/WinDialog';
import { RulesDialog } from '../components/RulesDialog';
import { router } from '@kit.ArkUI';
import { LeaderboardRecord } from '../model/LeaderboardRecord';
import { GameModel, GameMode, GameDifficulty, GameStatus, CellState } from '../model/GameModel';
import prompt from '@ohos.promptAction';


@Entry
@Component
struct SinglePlayerGame {
  @State gameModel: GameModel | null = null;
  @State showWinDialog: boolean = false;
  @State showSizeMenu: boolean = false;
  @State showDifficultyMenu: boolean = false;
  @State showRulesDialog: boolean = false;
  @State selectedSize: number = 4;
  @State selectedDifficulty: string = 'ä¸­ç­‰æ¨¡å¼';
  @State hasInitialized: boolean = false;

  aboutToAppear(): void {
    // åˆå§‹åŒ–æ¸¸æˆæ¨¡å‹ï¼Œä½†ä¸ç«‹å³å¼€å§‹æ¸¸æˆ
    this.initializeGameModel();
  }

  // åˆå§‹åŒ–æ¸¸æˆæ¨¡å‹
  private initializeGameModel(): void {
    // å°†éš¾åº¦æ˜ å°„åˆ°GameDifficultyæšä¸¾
    let gameDifficulty: GameDifficulty;
    switch (this.selectedDifficulty) {
      case 'ç®€å•æ¨¡å¼':
        gameDifficulty = GameDifficulty.EASY;
        break;
      case 'å›°éš¾æ¨¡å¼':
        gameDifficulty = GameDifficulty.HARD;
        break;
      default:
        gameDifficulty = GameDifficulty.MEDIUM;
    }
    
    this.gameModel = new GameModel(this.selectedSize, GameMode.SINGLE_PLAYER, gameDifficulty);
    this.hasInitialized = true;
  }

  checkGameCompletion(): void {
    if (this.gameModel && this.gameModel.checkGameComplete()) {
      this.showWinDialog = true;
    }
  }

  onCellClick(row: number, col: number): void {
    if (!this.gameModel) return;
    
    console.log(`SinglePlayerGame: ç‚¹å‡»æ ¼å­: (${row}, ${col})`);
    this.gameModel.toggleCell(row, col);
    this.checkGameCompletion();
  }

  onUndo(): void {
    if (this.gameModel) {
      this.gameModel.undo();
    }
  }

  onReset(): void {
    if (this.gameModel) {
      this.gameModel.reset();
      this.gameModel.startGame();
    }
  }

  onAutoSolve(): void {
    if (!this.gameModel) return;
    
    const success = this.gameModel.autoSolve();
    if (success) {
      prompt.showToast({ message: 'è§£é¢˜æˆåŠŸï¼' });
    } else {
      prompt.showToast({ message: 'å½“å‰ç›˜é¢æ— è§£æˆ–å·²å®Œæˆ' });
    }
  }

  onResetCurrent(): void {
    if (this.gameModel) {
      this.gameModel.resetCurrent();
    }
  }

  onChangeSize(size: number): void {
    this.selectedSize = size;
    this.initializeGameModel();
    this.gameModel?.startGame();
    this.showSizeMenu = false;
  }

  onChangeDifficulty(difficulty: string): void {
    this.selectedDifficulty = difficulty;
    this.initializeGameModel();
    this.gameModel?.startGame();
    this.showDifficultyMenu = false;
  }

  saveGameScore(): void {
    if (!this.gameModel) return;
    
    // è·å–æ¸¸æˆç”¨æ—¶ï¼ˆç§’ï¼‰
    const timeTaken = this.gameModel.timeElapsed;
    console.log('ä¿å­˜æˆç»©ï¼Œç”¨æ—¶:', timeTaken);
    
    // è·å–éš¾åº¦æ¨¡å¼
    const difficulty = this.selectedDifficulty;
    
    // è·å–æ£‹ç›˜å°ºå¯¸
    const boardSize = this.selectedSize;
    
    // è·å–å½“å‰æ—¶é—´æˆ³
    const timestamp = new Date().toLocaleString('zh-CN');
    
    // åˆ›å»ºæ–°çš„æ’è¡Œæ¦œè®°å½•
    const newRecord: LeaderboardRecord = {
      rank: 0, // æ’åå°†åœ¨æ’åºåè®¡ç®—
      playerName: 'ç©å®¶' + Math.floor(Math.random() * 1000), // ä¸´æ—¶ä½¿ç”¨éšæœºç©å®¶å
      boardSize: boardSize,
      difficulty: difficulty as 'easy' | 'medium' | 'hard' | 'ç®€å•æ¨¡å¼' | 'ä¸­ç­‰æ¨¡å¼' | 'å›°éš¾æ¨¡å¼',
      timeTaken: timeTaken,
      timestamp: timestamp
    };
    
    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    this.saveToLocalStorage(newRecord);
    
    // æ˜¾ç¤ºæˆåŠŸæç¤º
    prompt.showToast({ message: `æˆç»©å·²ä¿å­˜ï¼ç”¨æ—¶: ${this.formatTime(timeTaken)}` });
    
    // å…³é—­èƒœåˆ©å¼¹çª—
    this.showWinDialog = false;
  }
  
  private saveToLocalStorage(record: LeaderboardRecord): void {
    try {
      // è·å–ç°æœ‰çš„æ’è¡Œæ¦œæ•°æ®
      const existingData = AppStorage.get<string>('leaderboardData') || '[]';
      console.log('ä¿å­˜å‰ç°æœ‰æ•°æ®:', existingData);
      let leaderboardData: LeaderboardRecord[] = [];
      
      try {
        // è§£æJSONæ•°æ®
        const parsedData = JSON.parse(existingData) as object;
        
        // éªŒè¯æ˜¯å¦ä¸ºæ•°ç»„
        if (Array.isArray(parsedData)) {
          // è¿‡æ»¤å¹¶éªŒè¯æœ‰æ•ˆçš„LeaderboardRecordå…ƒç´ 
          leaderboardData = parsedData.filter((item: object) => {
            // ç¡®ä¿itemæ˜¯å¯¹è±¡
            if (item === null || typeof item !== 'object') {
              return false;
            }
            
            // éªŒè¯æ‰€æœ‰å¿…éœ€çš„å±æ€§å’Œç±»å‹
            return (
              (item['rank'] === undefined || typeof item['rank'] === 'number') &&
              typeof item['playerName'] === 'string' &&
              typeof item['boardSize'] === 'number' &&
              typeof item['difficulty'] === 'string' &&
              typeof item['timeTaken'] === 'number' &&
              typeof item['timestamp'] === 'string'
            );
          }).map((item: object) => item as LeaderboardRecord);
        }
      } catch (e) {
        console.error('è§£ææ•°æ®æ ¼å¼é”™è¯¯:', e);
      }
      
      // æ·»åŠ æ–°è®°å½•
      leaderboardData.push(record);
      
      // æŒ‰æ—¶é—´æ’åºï¼ˆæ—¶é—´è¶ŠçŸ­æ’åè¶Šé«˜ï¼‰
      leaderboardData.sort((a: LeaderboardRecord, b: LeaderboardRecord) => a.timeTaken - b.timeTaken);
      
      // æ›´æ–°æ’å
      leaderboardData.forEach((item: LeaderboardRecord, index: number) => {
        item.rank = index + 1;
      });
      
      // ä¿å­˜å›åº”ç”¨å­˜å‚¨
      const newData = JSON.stringify(leaderboardData);
      console.log('ä¿å­˜çš„æ–°æ•°æ®:', newData);
      AppStorage.set<string>('leaderboardData', newData);
      
    } catch (error) {
      console.error('ä¿å­˜æˆç»©å¤±è´¥:', error);
    }
  }
  
  // æµ‹è¯•æ–¹æ³•ï¼šæ·»åŠ æ¨¡æ‹Ÿæ’è¡Œæ¦œæ•°æ®ï¼ˆå·²ç§»é™¤æŒ‰é’®ï¼‰
  private addTestLeaderboardData(): void {
    try {
      // åˆ›å»ºæ¨¡æ‹Ÿæ•°æ®
      const testData: LeaderboardRecord[] = [
        {
          rank: 1,
          playerName: 'æµ‹è¯•ç©å®¶1',
          boardSize: 4,
          difficulty: 'ä¸­ç­‰æ¨¡å¼',
          timeTaken: 120,
          timestamp: new Date().toLocaleString('zh-CN')
        },
        {
          rank: 2,
          playerName: 'æµ‹è¯•ç©å®¶2',
          boardSize: 4,
          difficulty: 'ä¸­ç­‰æ¨¡å¼',
          timeTaken: 180,
          timestamp: new Date().toLocaleString('zh-CN')
        },
        {
          rank: 3,
          playerName: 'æµ‹è¯•ç©å®¶3',
          boardSize: 6,
          difficulty: 'ç®€å•æ¨¡å¼',
          timeTaken: 240,
          timestamp: new Date().toLocaleString('zh-CN')
        }
      ];
      
      // ä¿å­˜æµ‹è¯•æ•°æ®åˆ°åº”ç”¨å­˜å‚¨
      const testDataStr = JSON.stringify(testData);
      console.log('ä¿å­˜æµ‹è¯•æ•°æ®:', testDataStr);
      AppStorage.set<string>('leaderboardData', testDataStr);
      
      // æ˜¾ç¤ºæˆåŠŸæç¤º
      prompt.showToast({ message: 'æµ‹è¯•æ•°æ®å·²æ·»åŠ åˆ°æ’è¡Œæ¦œï¼' });
    } catch (error) {
      console.error('æ·»åŠ æµ‹è¯•æ•°æ®å¤±è´¥:', error);
      prompt.showToast({ message: 'æ·»åŠ æµ‹è¯•æ•°æ®å¤±è´¥' });
    }
  }

  private formatTime(seconds: number): string {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  navigateBack(): void {
    router.back();
  }

  build(): void {
    Stack() {
      // ä¸»èƒŒæ™¯
      Column() {}
      .width('100%')
      .height('100%')
      .backgroundImage($r('app.media.win'), ImageRepeat.NoRepeat)
      .opacity(0.1)

      // ä¸»å†…å®¹åŒºåŸŸ
      Column() {
        // é¡¶éƒ¨æ ‡é¢˜æ 
        Row() {
          Button({
            type: ButtonType.Circle,
            stateEffect: true
          }) {
            Text('â†')
              .fontSize(20)
              .fontColor('#FFFFFF')
          }
          .width(40)
          .height(40)
          .backgroundColor('transparent')
          .onClick(() => this.navigateBack())
          
          Text('å•äººæ¸¸æˆ')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FFFFFF')
            .flexGrow(1)
            .textAlign(TextAlign.Center)
          
          // å ä½å…ƒç´ ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­
          Column()
            .width(40)

          // å°ºå¯¸é€‰æ‹©æŒ‰é’®
          Button({
            type: ButtonType.Circle,
            stateEffect: true
          }) {
            Text(`${this.selectedSize}Ã—${this.selectedSize}`)
              .fontSize(14)
              .fontColor('#FFFFFF')
          }
          .width(50)
          .height(40)
          .backgroundColor('#6A89CC')
          .margin({ right: 10 })
          .onClick(() => this.showSizeMenu = true)

          // éš¾åº¦é€‰æ‹©æŒ‰é’®
          Button({
            type: ButtonType.Circle,
            stateEffect: true
          }) {
            Text(this.selectedDifficulty === 'ç®€å•æ¨¡å¼' ? 'ç®€' : this.selectedDifficulty === 'å›°éš¾æ¨¡å¼' ? 'éš¾' : 'ä¸­')
              .fontSize(14)
              .fontColor('#FFFFFF')
          }
          .width(40)
          .height(40)
          .backgroundColor('#4ECDC4')
          .onClick(() => this.showDifficultyMenu = true)
        }
        .width('100%')
        .height(80)
        .alignItems(VerticalAlign.Center)
        .linearGradient({
          direction: GradientDirection.Bottom,
          colors: [['#4A90E2', 0.0], ['#5D9CEC', 1.0]]
        })
        .shadow({ radius: 4, color: '#4A90E250', offsetX: 0, offsetY: 2 });

        // æ¸¸æˆå·¥å…·æ 
        GameToolbar({
          onRulesClick: () => { this.showRulesDialog = true; },
          onResetClick: () => this.onReset(),
          onResetCurrentClick: () => this.onResetCurrent()
        })

        // æ¸¸æˆç½‘æ ¼
        if (this.gameModel) {
          OOXXBoard({
            board: this.gameModel.board,
            onCellClick: (row: number, col: number) => this.onCellClick(row, col)
          })
        } else {
          Column() {
            Text('è¯·å…ˆé€‰æ‹©å°ºå¯¸å’Œéš¾åº¦å¼€å§‹æ¸¸æˆ')
              .fontSize(18)
              .fontColor('#666666')
              .margin({ top: 100 })
          }
          .width('100%')
          .height(300)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
        }

        // æ“ä½œæŒ‰é’®åŒºåŸŸ
        if (this.gameModel) {
          Row() {
            Button({
              type: ButtonType.Normal,
              stateEffect: true
            }) {
              Row() {
                Text('â†¶')
                  .fontSize(18)
                  .fontColor('#FFFFFF')
                  .margin({ right: 6 })
                Text('æ’¤é”€')
                  .fontSize(14)
                  .fontColor('#FFFFFF')
                  .fontWeight(FontWeight.Medium)
              }
            }
            .height(48)
            .flexGrow(1)
            .backgroundColor(this.gameModel.history.length > 0 ? '#FF6B9D' : '#E0E0E0')
            .borderRadius(24)
            .margin({ right: 10 })
            .enabled(this.gameModel.history.length > 0)
            .onClick(() => this.onUndo())

            Button({
              type: ButtonType.Normal,
              stateEffect: true
            }) {
              Row() {
                Text('ğŸ’¡')
                  .fontSize(18)
                  .fontColor('#FFFFFF')
                  .margin({ right: 6 })
                Text('è‡ªåŠ¨è§£é¢˜')
                  .fontSize(14)
                  .fontColor('#FFFFFF')
                  .fontWeight(FontWeight.Medium)
              }
            }
            .height(48)
            .flexGrow(1)
            .backgroundColor('#FFA726')
            .borderRadius(24)
            .margin({ right: 10 })
            .onClick(() => this.onAutoSolve())

            Button({
              type: ButtonType.Normal,
              stateEffect: true
            }) {
              Row() {
                Text('ğŸŒ¸')
                  .fontSize(18)
                  .fontColor('#FFFFFF')
                  .margin({ right: 6 })
                Text('é‡ç½®')
                  .fontSize(14)
                  .fontColor('#FFFFFF')
                  .fontWeight(FontWeight.Medium)
              }
            }
            .height(48)
            .flexGrow(1)
            .backgroundColor('#4ECDC4')
            .borderRadius(24)
            .margin({ left: 10 })
            .onClick(() => this.onReset())
          }
          .width('100%')
          .padding({ left: 20, right: 20, top: 16, bottom: 20 })
        }
      }
      .width('100%')
      .height('100%')

      // èƒœåˆ©å¼¹çª—
      if (this.showWinDialog) {
        WinDialog({
          onDismiss: () => { this.showWinDialog = false; },
          onNewGame: () => {
            this.showWinDialog = false;
            this.onReset();
          },
          onSaveScore: () => {
            this.saveGameScore();
          }
        })
      }

      // å°ºå¯¸é€‰æ‹©èœå•
      if (this.showSizeMenu) {
        Column() {
          Text('é€‰æ‹©ç›˜é¢å°ºå¯¸')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 20 })
          
          Row() {
            ForEach([4, 6, 8, 10], (size: number) => {
              Button({
                type: ButtonType.Normal,
                stateEffect: true
              }) {
                Text(`${size}Ã—${size}`)
                  .fontSize(16)
                  .fontColor('#FFFFFF')
              }
              .width(60)
              .height(50)
              .backgroundColor(this.selectedSize === size ? '#FF6B9D' : '#6A89CC')
              .margin({ right: 10 })
              .onClick(() => this.onChangeSize(size))
            })
          }
        }
        .width(300)
        .height(150)
        .padding(20)
        .backgroundColor('#FFFFFF')
        .borderRadius(12)
        .shadow({ radius: 8, color: '#00000020', offsetX: 0, offsetY: 4 })
        .position({ x: '50%', y: '50%' })
        .margin({ top: -75 })
      }

      // éš¾åº¦é€‰æ‹©èœå•
      if (this.showDifficultyMenu) {
        Column() {
          Text('é€‰æ‹©éš¾åº¦æ¨¡å¼')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 20 })
          
          Row() {
            ForEach(['ç®€å•æ¨¡å¼', 'ä¸­ç­‰æ¨¡å¼', 'å›°éš¾æ¨¡å¼'], (difficulty: string) => {
              Button({
                type: ButtonType.Normal,
                stateEffect: true
              }) {
                Text(difficulty === 'ç®€å•æ¨¡å¼' ? 'ç®€' : difficulty === 'å›°éš¾æ¨¡å¼' ? 'éš¾' : 'ä¸­')
                  .fontSize(16)
                  .fontColor('#FFFFFF')
              }
              .width(60)
              .height(50)
              .backgroundColor(this.selectedDifficulty === difficulty ? '#FF6B9D' : '#4ECDC4')
              .margin({ right: 10 })
              .onClick(() => this.onChangeDifficulty(difficulty))
            })
          }
        }
        .width(300)
        .height(150)
        .padding(20)
        .backgroundColor('#FFFFFF')
        .borderRadius(12)
        .shadow({ radius: 8, color: '#00000020', offsetX: 0, offsetY: 4 })
        .position({ x: '50%', y: '50%' })
        .margin({ top: -75 })
      }

      // è§„åˆ™å¯¹è¯æ¡†
      if (this.showRulesDialog) {
        RulesDialog({
          onDismiss: () => { this.showRulesDialog = false; }
        })
      }
    }
    .width('100%')
    .height('100%')
  }
}